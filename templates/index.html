{% extends "layout.html" %}
{% block title %}Record Audio{% endblock %}
{% block content %}
<h1>Welcome, {{ user_name }}</h1>

<div class="text-rec">
  <div id="eng-txt">
    <h2>English Recording</h2>
    <p>{{ english_text }}</p>
    <button id="startRecordingEnglish">Start English Recording</button>
    <div id="recordingIndicatorEnglish" style="display: none;">
      <img src="{{ url_for('static', filename='Microphone.gif') }}" alt="Recording..." style="width: 100px;">
      <b>Recording Started</b>
    </div>
    <button id="stopRecordingEnglish" disabled>Stop English Recording</button>
    <button id="listenEnglish" style="display: none">Listen English Recording</button>
    <audio id="audioPlayerEnglish" controls style="display: none"></audio>
    <button id="resetEnglish">Reset English Recording</button>
  </div>

  <div id="hin-txt">
    <h2>Hindi Recording</h2>
    <p>{{ hindi_text }}</p>
    <button id="startRecordingHindi">Start Hindi Recording</button>
    <div id="recordingIndicatorHindi" style="display: none;">
      <img src="{{ url_for('static', filename='Microphone.gif') }}" alt="Recording..." style="width: 100px;">
      <b>Recording Started</b>
    </div>
    <button id="stopRecordingHindi" disabled>Stop Hindi Recording</button>
    <button id="listenHindi" style="display: none">Listen Hindi Recording</button>
    <audio id="audioPlayerHindi" controls style="display: none"></audio>
    <button id="resetHindi">Reset Hindi Recording</button>
  </div>
</div>
<div id="submit-btn">
  <button id="submitAudio" style="text-align: center;">Submit</button>
  <button id="nextAudio" style="text-align: center;">Next</button>
</div>

<div id="loading-spinner" style="display:none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<script>
  let englishRecorder, englishAudioBlob;
  let hindiRecorder, hindiAudioBlob;
  let englishChunks = [];
  let hindiChunks = [];

  const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });

  function showAlert(message, type) {
    const alertContainer = document.getElementById("alert-container");
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert ${type}`;
    alertDiv.innerText = message;
    alertContainer.appendChild(alertDiv);
    setTimeout(() => {
      alertContainer.removeChild(alertDiv);
    }, 3000);
  }

  function showLoading() {
    document.getElementById("loading-spinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loading-spinner").style.display = "none";
  }

  function startRecording(language) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
      const source = audioContext.createMediaStreamSource(stream);
      const destination = audioContext.createMediaStreamDestination();
      source.connect(destination);

      const recorder = new MediaRecorder(destination.stream);
      const chunks = [];

      recorder.ondataavailable = (event) => {
        chunks.push(event.data);
      };

      recorder.onstop = () => {
        const audioBlob = new Blob(chunks, { type: "audio/wav" });
        if (language === 'english') {
          englishAudioBlob = audioBlob;
          document.getElementById("audioPlayerEnglish").src = URL.createObjectURL(englishAudioBlob);
          document.getElementById("listenEnglish").style.display = "block";
          document.getElementById("audioPlayerEnglish").style.display = "none";
          englishChunks = [];
        } else {
          hindiAudioBlob = audioBlob;
          document.getElementById("audioPlayerHindi").src = URL.createObjectURL(hindiAudioBlob);
          document.getElementById("listenHindi").style.display = "block";
          document.getElementById("audioPlayerHindi").style.display = "none";
          hindiChunks = [];
        }
      };

      recorder.start();
      if (language === 'english') {
        englishRecorder = recorder;
        document.getElementById("startRecordingEnglish").disabled = true;
        document.getElementById("stopRecordingEnglish").disabled = false;
        document.getElementById("recordingIndicatorEnglish").style.display = "block";
      } else {
        hindiRecorder = recorder;
        document.getElementById("startRecordingHindi").disabled = true;
        document.getElementById("stopRecordingHindi").disabled = false;
        document.getElementById("recordingIndicatorHindi").style.display = "block";
      }
    });
  }

  function stopRecording(language) {
    if (language === 'english') {
      englishRecorder.stop();
      document.getElementById("startRecordingEnglish").disabled = false;
      document.getElementById("stopRecordingEnglish").disabled = true;
      document.getElementById("recordingIndicatorEnglish").style.display = "none";
    } else {
      hindiRecorder.stop();
      document.getElementById("startRecordingHindi").disabled = false;
      document.getElementById("stopRecordingHindi").disabled = true;
      document.getElementById("recordingIndicatorHindi").style.display = "none";
    }
  }

  document.getElementById("startRecordingEnglish").onclick = () => startRecording('english');
  document.getElementById("stopRecordingEnglish").onclick = () => stopRecording('english');
  document.getElementById("listenEnglish").onclick = () => document.getElementById("audioPlayerEnglish").style.display = "block";
  document.getElementById("resetEnglish").onclick = () => {
    englishAudioBlob = null;
    document.getElementById("audioPlayerEnglish").src = "";
    document.getElementById("listenEnglish").style.display = "none";
    document.getElementById("audioPlayerEnglish").style.display = "none";
  };

  document.getElementById("startRecordingHindi").onclick = () => startRecording('hindi');
  document.getElementById("stopRecordingHindi").onclick = () => stopRecording('hindi');
  document.getElementById("listenHindi").onclick = () => document.getElementById("audioPlayerHindi").style.display = "block";
  document.getElementById("resetHindi").onclick = () => {
    hindiAudioBlob = null;
    document.getElementById("audioPlayerHindi").src = "";
    document.getElementById("listenHindi").style.display = "none";
    document.getElementById("audioPlayerHindi").style.display = "none";
  };

  document.getElementById("submitAudio").onclick = () => {
    if (!englishAudioBlob || !hindiAudioBlob) {
      showAlert("Both recordings are required", "warning");
      return;
    }

    showLoading(); // Show loading spinner

    const formData = new FormData();
    formData.append("audio_data_english", englishAudioBlob);
    formData.append("audio_data_hindi", hindiAudioBlob);
    formData.append("text_id", "{{ text_id }}");

    fetch("/upload", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        hideLoading(); // Hide loading spinner

        if (data.status === "success") {
          showAlert(data.message, "success");
        } else {
          showAlert(data.message, "error");
        }
      })
      .catch((error) => {
        hideLoading(); // Hide loading spinner
        showAlert("An error occurred. Please try again later.", "error");
      });
  };

  document.getElementById("nextAudio").onclick = () => {
    // Logic to load new text and reset recordings
    englishAudioBlob = null;
    hindiAudioBlob = null;
    document.getElementById("audioPlayerEnglish").src = "";
    document.getElementById("audioPlayerHindi").src = "";
    document.getElementById("listenEnglish").style.display = "none";
    document.getElementById("audioPlayerEnglish").style.display = "none";
    document.getElementById("listenHindi").style.display = "none";
    document.getElementById("audioPlayerHindi").style.display = "none";
    // Fetch new text or redirect to a new recording page
    // This will depend on your application logic
    location.reload(); // Example logic to reload the page with new text
  };
</script>
{% endblock %}
